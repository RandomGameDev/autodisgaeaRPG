
if (!patterns)
{
    patterns := {}
}

patterns.darkGates := {}
patterns.darkGates.block := "|<>0xEFE6EF@0.80$81.zzs01000DzU00Dzy000007zy001zzU00001yDk00Dzs00000T0S001zy03k003k1k7wzzU0S000w063zrzU03k007U0lzz4000S001s00D1s0001k00D001UD0000D001s00c1w0001sD0D01w0zU001j3k1s1zkTw00SzsS0D0TyDbUS3zz7U1s1XnkwTyDtts07U0Cw7bzlw7C00w01z0wwTD0zk07k0Ts7o1ts7w00S03z1y0DD0zk03s0zwzs7ts7z00DUDzzb3zb0Qw01zzzTk1yww3Xk03zxkU0T7bUQD00Dz4007Uww3ky00D0000s7bUS3s00000070ww3kC0001000sDnUC000000007byQ1U00000001zxvU0000000U07z00000000080ED0000000006024"
patterns.darkGates.title := "|<>0xFFFFFF@0.80$143.zs000000s0003zk000000001zz000001k000T7k000000003UT000003U001s1U001k000070D0000070007U10007U0000C0D00000C000S00000D00000Q0C00000Q000w00000S00000s0S0M0MksC03k000M1z0601Vk0w7y1zVks07U00Dw7z1zUTvU1sQS3z3X00D000MQ3k73VkT03kUQ7U7A00S1zUUw7UQ73UC07U0sC0Dk00w7z00sD0sC70Q0D01kQ0TU01s0S03kS1kSDUs0S1zUs0z003k0w1zUw7zwDtk0sD71k1z007U1sD71sDzsDvU3kQC3U3j00703ksC3kS007z071kQ707D00D07XkQ7UQ001y0S3UsC0CD00D0D7UsD0s003w3s71sQ0QS00T0SD3kC1s487zz0Djss0sS00DVwDDkTVssQTzU0Dvlk1US00DzUDnUz0zUTm"
patterns.darkGates.hl := {}
patterns.darkGates.hl.block := "|<>0xFFFFFF@0.80$73.s7C00zU0000CQ3b00zs00007C3nU0sC00003b1tk0w700001nUws0S3rC71txzyQ0D1vbDtzzzzC07UxnjzyTw7b03kStrjy7C3nU1sCQvzjXb1tnkQ7CRk1tnUwzsDzbyTrwtkSTw3zVyDvyQ00000DsA0s00000000S00000000000D000000000003000002"
patterns.darkGates.hl.title := "|<>0xFFFFFF@0.80$40.w07UQ03k0S3k0D01sD00w07UQ03k0S1k0D01s700w070Q03k0Q1k0D01k700zzz0Q03zzw1k0DU3k700w070Q03k0Q1k0D01k700w070Q03k0Q1k0D01s700w07UQ03k0S3s0D01sDzzw07UTzy"
patterns.darkGates.mats := {}
patterns.darkGates.mats.human := {}
patterns.darkGates.mats.human.block := "|<>0xFFFFFF@0.80$80.002000000000TU00U00000006Ds00A0000007lbz07700000z3yRly1k0001wTtzbQTUQ001Vz7yQxr7s700zwzlnrDRly1n6TzCQQzlrTzUQlbxz77DQxnzTzARrDtllryQzbzn7QnyTQMz701zQlrAvzz67U00Q7CRnCTyl000070nbQnbz000001kCznCk0000000Q3jsm0000000070tw0000000001k800000000000U"
patterns.darkGates.mats.monster := {}
patterns.darkGates.mats.monster.block := "|<>0xFFFFFF@0.80$63.0000001k000000000C0000000001k0080k0000C00zkC00001wTby1s0007TbwzsD0077vytr71sCDwzTDyswD7tzrUtzr7XtzbCS7D0swTCQtnsssb7ntnrCDb7yMyTSStlwsTm7zxnrCTb000zvjQtns0007SQzbA00000tnbsk0000070Q00000000s0000000004"
patterns.darkGates.mats.title := "|<>0xFFFFFF@0.80$81.0zy00000000000TXw00000000007U3U0000000001s0A0000000000D0000000000003k000000000000y0000000000007U000D03bUS03kw0007y0zzDs1zrU001ks7kz7UQ6w01UQ3Uw7kS307UTy3UQ7US3ks0w1bkw3kw3US3U7U0S7US7UQ1kTUw03kzzkw3UC1zbU0S7U07UQ1k3yS03kw00w3UC07vk0S7U07UQ1k0DD03kQ00w3US00tw0S3k47UQ3kkD3sDkD3Uw3US73kDzw0zs7UQ1kDwU"
patterns.darkGates.stage := {}
patterns.darkGates.stage.title := "|<>*129$73.y0zzzzzzzzzzw07zzzzzzzzzw01zzzzzzzzzw7sz7zzzzzzzy7yT3zzzzzzzz3zzVzzzzzzzzVzzkzzzzzbzzkDzU3s3zU1y1s0zk0k0z01y0S07y3sMD1Vy67U0z3wy7VsS7Vw0DVzz3kwD7kzU3kzw1sS73sTy1sTk0wD3U0DzUQDk0S73k07zsC7kQDU3sTyTwD3sS7s3wDz7y7VwD3sDz3w1y3ky71s0TUwE03s100C03s0C07y1k0700y0DkDznyDz3UTszzzzzzzzXwDzzzzzzzzzVy7zzzzzzzzzkz3zzzzzzzzzwD3zzzzzzzzzz03zzzzzzzzzzsDzzy"
patterns.darkGates.stage.label := ["|<>*102$59.Dvzkz0Dwzyk80X21UB060E14460+0A1k28480o0sSswU8Vz8zkEFV0930FzUEX2MG6SU7UF68kIB30BUGAE0cO6DlUYN01koATDV8mDVksszk2FYzXU1E1UDXl13U6U3zzzzXRztzy"
                                , "|<>*111$59.Dzzkz0TyzzU80X2105060E14640+0ATwC84MToTsSswUAVz8zEMFV4930E3UMX6MG6zU7UF68kIB30BUGAE0cO6DnUYN00kwATjV8mDVksszk2lwzXk1E1UDXl1ak6U3zzzznwztzy"
                                , "|<>*111$59.Tzzkz0zyzzU80X2305060E14240+0ATwSM4MzoTsM8kUAVU8zEMFVA930E3UMX4MO6zU6UF680IB30BUGAE0sO6DnkYN00swQTc18mTVk0s0k2lsxVk1E1UDXtVak6U3zzwznyztzy"
                                , "|<>*107$59.7tzUS07wTwkA0V61kB060E14460+0A0k28480o0MTswk8VzczkEFV0930FyUEX2MG6SU7UF68koBb0BUmAE0cO6DtUYMU1koATjV8m01lsszk2FYz3U1k1UBXl13U2U3zzzvXRzxzy"]
patterns.darkGates.stage.1 := "|<>*99$7.zkMC5WlMgK/5WlMbs"          ;use 10 percent variance
patterns.darkGates.stage.2 := "|<>*97$10.TW182y9sV288VYAVWDs1U7zs"  ;use 25 percent variance
patterns.darkGates.stage.threeStars := "|<>0x2A2219@0.58$77.zyzzzzrzzzyzzzwzzzz7zzztzzzkzzzyDzzzlzzzVzzzsDzzz3zzy1zzzkTzzy3zzw3zzz0Tzzs3zzk3zzy0TzzU7zk00Ty003zk00Q0007U000w0004000DU003s000Q001zU00Dw001w003zU00zw007w00DzU03zs00Tw00zzU0Dzs01zs03zz00Tzs03zk07zy00zzk07zU0Dzw01zz00Dz00Tzs03zy00Ty00zzk07zw00zw7Uzz0wDzsDVzszlzyDyTzlznzrzzzwzzzzjzzs"

DoDarkGateHL() {
    DoDarkGate("hl")
}

DoDarkGateMatsHuman() {
    DoDarkGate("matsHuman")
}

DoDarkGateMatsMonster() {
    DoDarkGate("matsMonster")
}

DoDarkGate(type) {
    global patterns, settings, guiHwnd
    ControlGetText, gateCount, edit3, % "ahk_id " . guiHwnd
    SetStatus(gateCount, 2)

    gateCount++

    if (type = "hl") {
        battleOptions := settings.battleOptions.darkGateHL
        targetBlock := patterns.darkGates.hl.block
    }
    else {
        battleOptions := settings.battleOptions.darkGateMats
        if (type == "matsHuman") {
            targetBlock := patterns.darkGates.mats.human.block
        } else if (type == "matsMonster") {
            targetBlock := patterns.darkGates.mats.monster.block
        }
    }
    
    targetCompanions := []
    for k, v in battleOptions.companions
        targetCompanions.push(patterns.companions[v])

    loopTargets := [patterns.stronghold.gemsIcon, patterns.dimensionGate.background, patterns.darkGates.title
        , patterns.darkGates.stage.title, patterns.companions.title, patterns.battle.title, patterns.battle.auto
        , patterns.battle.prompt.battleAgain]

    Loop {
        result := PollPattern(loopTargets)

        if InStr(result.comment, "stronghold.gemsIcon") {
            FindPattern(patterns.tabs.dimensionGate, { doClick : true })
            sleep 1000
        }
        else if InStr(result.comment, "dimensionGate.background") {
            FindPattern(patterns.darkGates.block, { doClick : true })
            sleep 1000
        }
        else if InStr(result.comment, "darkGates.title") {
            FindPattern(targetBlock, { doClick : true })
            sleep 1000
        }
        else if InStr(result.comment, "darkGates.stage.title") {
            gateCount--
            ControlSetText, edit3, % gateCount,  % "ahk_id " . guiHwnd
            SetStatus(gateCount, 2)

            if (gateCount <= 0) {
                Break
            }
            FindAndClickListTarget(patterns.darkGates.stage.threeStars, patterns.companions.refresh)
            sleep 1000
        }
        else if InStr(result.comment, "companions.title") {
            FindAndClickListTarget(targetCompanions)
            sleep 1000
        }
        else if InStr(result.comment, "battle.title") {
            FindPattern(patterns.battle.start, { doClick : true })
            sleep 500
            if (HandleInsufficientAP()) {
                PollPattern(patterns.battle.start, { variancePct : 5, doClick : true }) 
            }
            sleep 1000
        }
        else if InStr(result.comment, "battle.auto") {
            DoBattle(battleOptions)
            PollPattern(loopTargets, { callback : Func("MiddleClickCallback"), pollInterval : 250 })
        }
        else if InStr(result.comment, "battle.prompt.battleAgain") {
            FindPattern(patterns.battle.prompt.battle, { doClick : true })
            sleep 500
            if (HandleInsufficientAP()) {
                PollPattern(patterns.battle.prompt.battle, { variancePct : 5, doClick : true }) 
            }
        }
    }

    ExitApp
}