if (!patterns)
{
    patterns := {}
}

patterns.itemWorld := {}
patterns.itemWorld.block := "|<>0xAAA4AA@0.88$89.y000000031k00CCw000000wC3U0Pwts000000sS71kzvXk000001kwCTttr7U000003lwMtvVyD0000003XsnVz3wS0000007ava1y7syM0007U7ArA3gDlws03jzUCNiM7MRltk77zbUCnssCkNnnszjD70TXlkRklbjnbQCC0S7XlnVUDTC7sQQ0wD3z700SCMTkss0sC1w000wQzzlkk1kQ00001sti3XVU1U000001tn0733000000003nb0i66000000007X77AA000000000D77wE0000000000SD7U00000000000w60000000000001k0000000000000E"
patterns.itemWorld.title := "|<>0xFFFFFF@0.78$142.s0000000000s1k700000S00TU0000000003UD0Q00001s01y1k00000000D0w1k00007U07sD000000000w3s600000S00TUQ000000001kDUM00001s01y1k0000000071i3U00007U07sTs3U3b1s00S6wA0C0CQS1zzXzUzkDzDs01sNkk3z0zlsDjy3k73UwTXU03V730wC3z7VsDs70sC3kwD00DASM3UQD0S70zUQ3UQC3kQ00wltUS1ks1sQ1y1kC1ksD1k01n3a1k7XU7Xk7s71zz3Uw7007MCM70SC0SD0TUQ7zsC3kQ00TUz0Q1ss1sw1y1kS00sD1k01y1w1k7XU7Xk7s70s03Uw7003k7k70QC0S70zUQ3U0C3kQ00D0S0S1ks1sQ3y1kD1UsD1k00w0s0sD3U7VsTs7sTC3Uw7001k3U1tsC0S3zzUDUTkC3UQ0060A03y0s1k3ts"
patterns.itemWorld.subdue := "|<>*119$71.Q1szlDnky0z1U3UT27YVs00204QS7aN3k0047vyADUy700087DzcTnwDzszk7lkk3y0MML1k7VVU3k0kkc1UD3303U1VVk1UC667673333VUAAAC4C6660DUMMMQMQAAA0TUkkkkksMMMTU1U3U1k0k0s107U707U1k3k30DUT0TU3kDs4"
patterns.itemWorld.bribe := {}
patterns.itemWorld.bribe.block := "|<>*122$53.Ts0Htw0T10ASA+A1y20Dz8QM3w40C3ksE7w8ME1VkUDwEkjzzVsTzVVka70MkR07UAC0+0C070MQ0I0Q0C0ksMEsMMADVlkU0kkMF3XV01VVky7737z03VwC0C0+073sQ0y0I0yDks3y0jzzzzzzzzk"
patterns.itemWorld.bribe.goldenCandy := "|<>*161$41.E203znyE20477wk60001sk60803kk60Q0zUk60c0z0k61M0y0k62E0y7ry4k0uDrq9U1qTrkFU1zTq1X03yzm3303yzkC607yzkw40/yz3sA0PyQDw80Pq0zzM0va3zzE1s0Dzzk0M0zzyU0M3zzzU0MDzzx0U0zzzz103zzxu20Dzzza60zzzv023zzzs0EDzzzk2VzzzzURzzzzw1zzzzz0Dzzzzw1zvzzzUDzzzzw1zzzzzUDzzzrw1zzzz10Dzzzz01zzzzwRzzzzy07zzzzk"
patterns.itemWorld.bribe.goldBar := "|<>*174$41.z00003zv0000Dzrk003zzjs00Tzyzy03zzxzz0TzzDzzlzzyTzznzzwTzzbzzvzzzDzzrzzyTzzrzzwzzzvzztzzxyzznzzXzTzbzw7zjzDzUDz7yTw0TyTwzU0zwztw01ztyTU03zvyA007zrzU00Dzjzk00TzTzs03zyzzy07zxzzz0DzvzzzU7zrzzz0DzzzzyNzzzzzwnzzzzztzzzzzznzxyzzzbzkTzzzDzVzzzyTzjzzzwzzTzzztzzzzzznzzzzzzrzzzzzzzzzzzzzzk"
patterns.itemWorld.bribe.crabMiso := "|<>*135$41.0060Q0E00E040U010040004005000800+000000Y002000E00480EU0040010008004000EMM8000F0AE000U0d000011200010s00703U0k0Tk0zw02Dw0000MDzw000Hzzzw001Tzzs002Xzzs004n7yE0697X0S0TlwG0sTy4kA3QzwMUAMLzsDYAszzkCvwDzzb70TbzzCs04tzkRr0GNy0Pj05A043y5OU0D0A2h01zU0020TTy000DyTzzzzzsTzzzzz4Dzzzzy+jk7s3yE"
patterns.itemWorld.bribe.confirm := "|<>*122$49.07zyQTzzXVzz6DzzlwTzr7zzsyDzzXzzwT7ztl3zyD7UAs0T107kiQCDC00szCDX71wQTb7lbUz6DnXsU0EX49l4Ey8FW4MWAh7lF24++800UV208X030EY0A87s1kCTs3u"
patterns.itemWorld.nextLevel := "|<>*142$111.7yTzzzzzzwTzzzzzzzUTnzzzzwzzXzzzzzzzw1yTzzzz7zwTzzzzzzzUDnzzzzszzXzzzzzzzw0yTvyTy1zwTzxzDvyzV3ns3ltk7zXzw1lyS0wACSCC6D7zwTz767bXbVknnlsHszzXztwswswQD2QTDUz7zwTzDb3j7XVwHU1yDszzXzk0QNs0QDUQ0Dkz7zwTy07XD03Vy3Xzw3szzXzlzy3szwDsQTzAD7zwTzDzkT7zVzXltllszzXzsyz7wSQDyT0AT7Uzw03U7szk3bzzw7rwyDzzzz3zzz1zU"
patterns.itemWorld.leave := "|<>*163$114.7zzzzzzzzzzyTzzzzzz7zzzzzzzzzzyTDzzzzz7zzzzzzzzzzyTDzzzzz7zzzzzzzzzzyTDzzzzz7zzzzzvzzzzyS3zzzbn7zw3s3lwy1zyQ1s3k107ztlvllwwwzyTDlnksQ7zntztsxswzyTDnllsw7zntzlsttwTyTDXllsw7zU0w1wPs0TyTDU1lsw7zVVstwHs0zyTDU3lsw7zXzltyHtzzyTDXzlsw7znzlty7szzyDDXzlsw7zlxllz7wyzyD7ltlsw00sFk0TDw8zyD1sllswzzy7wRzzz3zzzXy7zzzU"
patterns.itemWorld.level := {}
patterns.itemWorld.level.10 := "|<>*100$77.DzzzzzzXzzTwCTzzzzzz7zszUAzzzzzzyDz1zD9zzzzzzwTw3wS3zzzzzzszv7sw7zkQTC3lzyDlsDz6QwsnXzwT7kTyQMtnX7zsyDkzswlr76DzlwT1zk1lC0ATzXwS3zXzWwTszz7sw7z7zVszlzyDls7r7D7ttXzwTnm070zDs77zszU7zz3zzsTzzzzkw"
patterns.itemWorld.level.20 := "|<>*124$77.jzzzzzzXzsTwCTzzzzzz7z0DkAzzzzzzyDywTD9zzzzzzwTxwQS3zzzzzzszzssw7zsQTC3lzznnwDz6QwsnXzz77sTySMtnn7zwSDkzswtr7aDztwTVzk1lC0ATzbwz3zXzWwTszyTsw7zbzVszlztzls7zDD7ttXzU3nm070zDs77y07kDzzXzzwzzzzzkw"
patterns.itemWorld.level.30 := "|<>*118$77.DzzzzzzXzU7s6Tzzzzzz7zT7bYzzzzzzyDzyCD1zzzzzzwTzwQS3zwCDb1szzltw7zXCSQNlzw7XwDzDAQtlXzs77sTwSQvXX7zz6Dkzs0sb06DzyCT1zlzlSDwTzwQS3znzkwTszzssw3zbbXwwlzbVtt03UTbw3Xz07k7"
patterns.itemWorld.level.100 := "|<>0xFFFFFF@0.70$89.k000000M03U6M6NU000000k0D0MMMP0000001U1i1UkkS000000300Q31nUw03lUEy600s63b1s0MlVX6A01kA7C3k0lX26AM03UsCM7U11X4MQk070kQsD07z6EztU0C1UtkS0C06VU300Q31nUw0A0D30600s6331s0MEA32A01k6666zsNUM3AM03U6M6N"
patterns.itemWorld.drop := ["|<>0xFFFFFF@0.94$15.z1yQ7nUSQ3nUSQ3nUSQ3nUTs3z0Q"]
                          ;, "|<>0xFFFFFF@0.94$15.zVyA3lUSA3lkSC3lkSA3lUTw3TUQ"
                          ;, "|<>0xFFFFFF@0.87$15.T1zwDnUSQ3nUSQ3nUSQ3nUSQ3zUTw3U"
                          ;, "|<>0xFFFFFF@1.00$15.TVyA3lUSA3lkSC3lUSA3lUTw3TUQ"
                          ;, "|<>0xFFFFFF@1.00$15.z1y83lUSA3lUSA3lUSA3l0Ts3T0Q"]
patterns.itemWorld.armor := {}
patterns.itemWorld.armor.disabled := "|<>*108$67.zbzzzzzzzzzzXzzzzzzzzzzkzzzzzzzzzzkTzzzzzzzzzsDzzzzzzzzztXyNl7XznzAwlz0s00T0D0SwTXwACD7XVySDlyD7XXtlzD3tz7XlXwMz01wzXlslyATU0STlswMz6DrwDDswSATX7nz7bwSD77XXlzVnyD7XXlltzslz7Xls1szzzzzzzzz3zz"
patterns.itemWorld.armor.enabled := "|<>0xFFFFFF@0.81$67.0E0000000000Q0000000000C0000000000DU0000000007k0000000002Q1a4MA000n3C0z7zTUTkTV3UQ3VkkMQC1VkA1ksMM660kM60sQCA330MS30QC7C1lUTz1UC73b0sk81kk73VlUMMA0sM3VkskAA60SA1ksQAC660760sQC3y3000000000M01"
patterns.itemWorld.weapon := {}
patterns.itemWorld.weapon.disabled := "|<>0xA4A4A4@0.80$85.s70k0000000000Q3UM000000000071kA00000000003VwA00000000001ky600000000000sL30Q0A0nU1U6QC9V0zUzUzs7w7z7AtUssEsSC733lnaQkMA0QC3X1lkMu7MA60C71nUMsAT3cDzVz3UtkCQ6DVw7U1nVkQs7C37ky3U1lksCQ771VkD0s8ssQ763XUks70QAQQD73XlkMQ3U7yDz7z0zksA0000w1l3j07U0000000001k0000000000000s0000000000000Q0000000000000C000004"
patterns.itemWorld.weapon.enabled := "|<>0xFFFFFF@0.80$85.M20k0000000000Q3UM000000000061kA00000000003VsA00000000001ky600000000000MH3080A0X0106MC9V0zUzUzs7w7z7AtUMsEsSC733lnaQkMA0AC3X1lkMm6EA60C71nUMsAR3c7z1z3UtkAQ6DVw701VVkQs6C33US1U1UksCQ371VkC0k0kMQ663XUks70A4QQC73VVkM81U3w7z7r0zUsA0000M1U3i0300000000001k0000000000000s0000000000000Q0000000000000C000004"

patterns.itemWorld.item := {}
patterns.itemWorld.item.name := "|<>0xFEDA8C@0.75$35.kU0001n00003a00007gD3y3DMy7yDzlgBgnrXMPRzb7wqnv67thXw"
patterns.itemWorld.item.legendary := ["|<>0x261718@0.60$41.zzzzzzzb8karsDC11070CQkuSC6Qttww9Atk3xh6NrUYTzBnbDCzyPbCSRjgnC4APTRYw0467v3TzzDzzzTzzzzzz"
                                    , "|<>0x1C1213@0.60$41.TzzzzTtbClzzzTC11070SQ0G+C4QttwwAAtm3ts2NnU6ASBnjB8zyPbCSRjgnCQwvTRYQ04K6v1NlwBzyDzzzzzzz"
                                    , "|<>0x3B2C1D@0.60$41.zzzzzzzD9VibmSS211CUQwoqSBANttwwOQnk7vvItbUATzRnDCRzynaSQNzwqQAQmTx8c8A4Du3zzzTzzzU"
                                    , "|<>0x271A1A@0.60$41.zzzzzztjBnzzzyS311DUQQ4mGB4tttwwOMnm7tuItbUCQy9nD+MzynaSQtzQaAwsmStAs08Y7u3Nlw9voDzzzzzzz"]
patterns.itemWorld.go := "|<>0xF8F7F7@0.75$198.0zU0000000004000000000k60E0000s073ks000000000A000000001k60k0000s07708000080000Q300000000sD0k0000s07C000000M0000Q700000000sD0k0000s07S000000Q0000A700000000sDVU0000s07Q000000Q0000A700000000s/VU0000s3bQ003w01z0y00ATsDURwy00QPVUDkCssDzw007700Q3XU0A70MkSDb00QFV0MMDssQDw0AC300M71k0A70kMQD3U0QFn0sAC0sQ7w7wQ3U0M70k0A71kMQ63U0Cln1kCC0ss7w0QQ3U0Q70s0A71kQQ63U0Ckn1kCC0ss7Q0QQ3U0M60s0A71zwQ63U0CUu1kCC0ss7Q0QQ3U0M60s0A71k0Q63U0DUy1kCC0ss7Q0QQ3U0M70s0Q71k0Q63U07US1kCC0ss7C0QA3U0M71k0Q71k0Q63U07UQ0kCC0sQ770QC300Q31k0Q70s8Q63U070Q0sQC0sQD3lw7C00T1nU0Q7kQsQ63U030A0QsC0sDz0z01s00D0S0003k7U0000000007U0003UU"

#Include common.ahk

DoItemWorldLoop(type := "") {
    global patterns, settings
    SetStatus(A_ThisFunc)
    
    sortDone := false
    doWeapon := settings.itemWorldOptions.loop.itemType = "weapon" ? true : false
    settings.itemWorldOptions.bribe := ""        ;shouldn't want to spend game resources while in loop mode
    settings.itemWorldOptions.targetItem := "any"
    settings.itemWorldOptions.farmTrigger := patterns.itemWorld.level
    battleOptions := settings.battleOptions.itemWorld
    battleOptions.preBattle := Func("ItemWorldPreBattle")
    battleOptions.onBattleAction := Func("ItemWorldOnBattleAction")
    battleOptions.donePatterns := [patterns.itemWorld.title]
    targetSort := "ascending"
    targetItem := patterns.itemWorld.item.name
    
    if (type = "farmLegendary") {
        settings.itemWorldOptions.targetItem := "legendary"
        settings.itemWorldOptions.farmTrigger := patterns.itemWorld.level.100
        targetSort := "descending"
        targetItem := patterns.itemWorld.item.legendary
        doWeapon := settings.itemWorldOptions.farmLoop.itemType = "weapon" ? true : false
    }

    targeSortInverse := targetSort = "ascending" ? "descending" : "ascending"

    loopTargets := [patterns.stronghold.gemsIcon, patterns.dimensionGate.background, patterns.itemWorld.title, patterns.itemWorld.leave, patterns.battle.auto]
    Loop {
        result := PollPattern(loopTargets)

        if InStr(result.comment, "stronghold.gemsIcon") {
            FindPattern(patterns.tabs.dimensionGate, { doClick : true })
            sleep 1000
        }
        else if InStr(result.comment, "dimensionGate.background") {
            FindPattern(patterns.itemWorld.block, { doClick : true })
            sleep 1000
        }
        else if InStr(result.comment, "itemWorld.title") {
            PollPattern(patterns.itemWorld.armor.disabled, { doClick : true, predicatePattern : patterns.itemWorld.armor.enabled })
            if (doWeapon) {
                PollPattern(patterns.itemWorld.weapon.disabled, { doClick : true, predicatePattern : patterns.itemWorld.weapon.enabled })
            }
            
            if (!sortDone) {
                PollPattern(patterns.sort.button, { doClick : true, predicatePattern : patterns.sort.title })
                if (FindPattern(patterns.sort.rarity.disabled).IsSuccess) {
                    PollPattern(patterns.sort.rarity.disabled, { doClick : true, predicatePattern : patterns.sort.rarity.enabled })
                    sleep 100
                }
                if (FindPattern(patterns.sort[targeSortInverse].checked, { variancePct: 5 }).IsSuccess) {
                    PollPattern(patterns.sort[targetSort].label, { variancePct: 5, doClick : true, offsetX : 40, predicatePattern : patterns.sort[targetSort].checked })
                    sleep 100
                }
                PollPattern(patterns.prompt.ok, { doClick : true, predicatePattern : itemWorld.title })
                sortDone := true
            }
            
            sleep 500
            PollPattern(targetItem, { doClick : true, predicatePattern : patterns.itemWorld.go })
            PollPattern(patterns.itemWorld.go, { doClick : true, predicatePattern : patterns.battle.start })
            PollPattern(patterns.battle.start, { doClick : true })
            DoItem()
        }
        else if InStr(result.comment, "itemWorld.leave") {
            ClickResult(result)
            sleep 1000
        }
        else if InStr(result.comment, "battle.auto") {
            DoItem()
            sleep 1000
        }
    }
}

DoItemWorldFarmLoop() {
    DoItemWorldLoop("farmLegendary")
}

ItemWorldFarm() {
    global patterns, settings

    battleOptions := settings.battleOptions.itemWorld
    battleOptions.preBattle := Func("ItemWorldPreBattle")
    battleOptions.onBattleAction := Func("ItemWorldOnBattleAction")
    battleOptions.donePatterns := [patterns.itemWorld.title]

    DoBattle(battleOptions)
}

ItemWorldPreBattle() {
    SetStatus("DoItem")
    global patterns, settings

    result := FindPattern(settings.itemWorldOptions.farmTrigger, { variancePct : 5 })

    if (result.IsSuccess) {
        if (!FindPattern([patterns.battle.done, patterns.itemWorld.drop], { variancePct : 15 }).IsSuccess)
        {
            DoItemDrop()
        }
    }
}

ItemWorldOnBattleAction(result) {
    global patterns

    IF FindPattern(patterns.itemWorld.subdue).IsSuccess
        DoSubdue()
    Else
        ClickResult(result)
}

DoItemLoop() {
    SetStatus(A_ThisFunc)
    global patterns

    result := FindPattern([patterns.battle.auto.enabled, patterns.battle.auto.disabled]) 
    if (InStr(result.comment, "battle.auto")) {
        DoItem()
    }

    Loop {
        FindPattern(patterns.itemWorld.leave, { doClick : true })
        PollPattern(patterns.itemWorld.armorDisabled, { doClick : true, predicatePattern : patterns.itemWorld.armorEnabled })
        PollPattern(patterns.itemWorld.item.name, { doClick : true, predicatePattern : patterns.itemWorld.go })
        PollPattern(patterns.itemWorld.go, { doClick : true, predicatePattern : patterns.battle.start })
        PollPattern(patterns.battle.start, { doClick : true })
        DoItem()
    }
}

DoItem() {
    SetStatus(A_ThisFunc)
    global patterns, settings

    battleOptions := settings.battleOptions.itemWorld

    Loop {
        DoBattle(battleOptions)
        result := PollPattern([patterns.itemWorld.nextLevel, patterns.itemWorld.leave], { variancePct : 10, doClick : true, doubleCheck : true, doubleCheckDelay : 250, callback : Func("MiddleClickCallback") })
        if (InStr(result.comment, "leave")) {
            sleep 1000
            Break
        }
    }
}

DoItemDrop() {
    SetStatus(A_ThisFunc, 2)
    global patterns, settings

    battleOptions := settings.battleOptions.itemWorld

    actions := []
    singleTargetActions := []

    ;loop through skill list
    for k, v in battleOptions.skills
    {
        actions.Push(patterns.battle.skills[v])
    }

    for k, v in battleOptions.singleTargetSkills
    {
        singleTargetActions.Push(patterns.battle.skills[v])
    }

    actions.Push(patterns.battle.attack)
    singleTargetActions.Push(patterns.battle.attack)

    Loop {
        count := 0
        Loop {
            FindPattern(patterns.battle.auto.enabled, { doClick : true })

            result := FindPattern([patterns.battle.wave.1over3, patterns.battle.wave.2over3, patterns.battle.wave.3over3])
            if (result.IsSuccess) {
            RegExMatch(result.comment, "(?P<wave>\d)over(?P<numWaves>\d)", matches)
            SetStatus(A_ThisFunc . ": " . matchesWave . "/" .  matchesNumWaves . "(" . count . ")", 2)
                if (InStr(result.comment, "3over3"))
                    Break
            }

            result := FindPattern(patterns.battle.skills.label)
            if (result.IsSuccess) {
                result := FindPattern([patterns.battle.wave.3over3, actions], { variancePct : 5, doClick : true })
                if (InStr(result.comment, "3over3")) {
                    Break
                }
            }

            sleep, 250
            
            if (FindPattern([patterns.battle.done, patterns.itemWorld.drop], { variancePct : 15 }).IsSuccess) {
                SetStatus(A_ThisFunc . ": Done", 2)
                Break
            }

            count++
            SetStatus(A_ThisFunc . ": " . matchesWave . "/" .  matchesNumWaves . "(" . count . ")", 2)

            if (mod(count, 250) = 0) {
                Resize(true)
            }
        }

        if (FindPattern([patterns.battle.done, patterns.itemWorld.drop], { variancePct : 15 }).IsSuccess) {
            SetStatus(A_ThisFunc . ": Done", 2)
            Break
        }
        
        PollPattern(patterns.enemy.A, { doClick : true, offsetX : 40, offsetY : -30 })
        sleep 400
        result := FindPattern(patterns.enemy.target)

        while (!result.IsSuccess) {
            PollPattern(patterns.enemy.A, { doClick : true, offsetX : 40, offsetY : -30 })
            sleep 400
            result := FindPattern(patterns.enemy.target)
        }

        ;Don't know why this keeps failing but let's just check at least 3 times
        Loop, 3 {
            result := FindPattern(patterns.enemy.A)
            ;Keep attacking the item boss/king
            While (result.IsSuccess)
            {
                FindPattern(singleTargetActions, { variancePct : 15, doClick : true, doubleCheck : true, doubleCheckDelay : 250 })
                sleep 1000
                result := FindPattern(patterns.enemy.A)
            }
            sleep, 500
        }

        sleep 2000
        result := FindDrop()

        ; if (result.type = "legendary") {
            
        ; }

        if (result.IsSuccess && (settings.itemWorldOptions.targetItem = "any" || InStr(settings.itemWorldOptions.targetItem, result.type))) {
            Break
        }
        Else {
            PollPattern(patterns.menu.button, { doClick : true, predicatePattern : patterns.menu.giveUp })
            PollPattern(patterns.menu.giveUp, { doClick : true, predicatePattern : patterns.prompt.yes })
            PollPattern(patterns.prompt.yes, { doClick : true, predicatePattern : patterns.prompt.retry })
            PollPattern(patterns.prompt.retry, { doClick : true })
        }
        sleep 1000
    }
}

FindDrop() {
    global patterns

    legendResult := FindPattern(patterns.itemWorld.drop, { variancePct : 15, bounds : { x1 : 359, y1 : 51, x2 : 378, y2 : 89 } })
    rareResult := FindPattern(patterns.itemWorld.drop, { variancePct : 15, bounds : { x1 : 291, y1 : 51, x2 : 312, y2 : 89 } })
    anyResult := FindPattern(patterns.itemWorld.drop, { variancePct : 15 })
    
    result := {}

    if (legendResult.IsSuccess) {
        Return { type : "legendary", IsSuccess : true }
    }

    if (rareResult.IsSuccess) {
        Return { type : "rare", IsSuccess : true }
    }
    
    if (anyResult.IsSuccess) {
        Return { type : "any", IsSuccess : true }
    }

    Return { IsSuccess : false }
}

DoSubdue() {
    global patterns, settings
    
    if (settings.itemWorldOptions.bribe && settings.itemWorldOptions.bribe != "None") {
        PollPattern(patterns.itemWorld.bribe, { doClick : true, predicatePattern : patterns.itemWorld.bribe[settings.itemWorldOptions.bribe] })
        PollPattern(patterns.itemWorld.bribe[settings.itemWorldOptions.bribe], { doClick : true })
        PollPattern(patterns.itemWorld.bribe.confirm, { doClick : true, predicatePattern : patterns.itemWorld.subdue })
    }

    PollPattern([patterns.itemWorld.subdue], { doClick : true })
}



